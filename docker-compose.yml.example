version: "3.9"

services:
  django-server:
    build:
      context: ./server
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - DJANGO_SECRET_KEY=your-secret-key-here
      - DJANGO_DEBUG=true
      - DJANGO_ALLOWED_HOSTS=*
      - CORS_ALLOW_ALL_ORIGINS=true
      - CORS_ALLOWED_ORIGINS=
      - CSRF_TRUSTED_ORIGINS=
      - DB_ENGINE=postgres
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=lol_rewind
      - CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672//
      - CELERY_RESULT_BACKEND=rpc://
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672//
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
      - RABBITMQ_DEFAULT_VHOST=/
      - RIOT_API_KEY=your-riot-api-key-here
      - DEFAULT_MATCH_YEAR=2025
    volumes:
      - ./server:/app
      - server_static:/app/staticfiles
      - server_db:/app/db
    working_dir: /app
    depends_on:
      - postgres
      - rabbitmq
    restart: unless-stopped

  celery-worker:
    build:
      context: ./server
      dockerfile: Dockerfile
    command: celery -A config worker -l info
    environment:
      - DJANGO_SECRET_KEY=your-secret-key-here
      - DJANGO_DEBUG=true
      - DJANGO_ALLOWED_HOSTS=*
      - CORS_ALLOW_ALL_ORIGINS=true
      - CORS_ALLOWED_ORIGINS=
      - CSRF_TRUSTED_ORIGINS=
      - DB_ENGINE=postgres
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=lol_rewind
      - CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672//
      - CELERY_RESULT_BACKEND=rpc://
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672//
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
      - RABBITMQ_DEFAULT_VHOST=/
      - RIOT_API_KEY=your-riot-api-key-here
      - DEFAULT_MATCH_YEAR=2025
    volumes:
      - ./server:/app
    working_dir: /app
    depends_on:
      - postgres
      - rabbitmq
    restart: unless-stopped

  postgres:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=lol_rewind
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  rabbitmq:
    image: rabbitmq:3-management-alpine
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
      - RABBITMQ_DEFAULT_VHOST=/
    ports:
      - "5672:5672"    # AMQP port
      - "15672:15672"  # Management UI port
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ./server/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./server/rabbitmq-definitions.json:/etc/rabbitmq/definitions.json:ro
    restart: unless-stopped

volumes:
  server_static:
  server_db:
  postgres_data:
  rabbitmq_data:
